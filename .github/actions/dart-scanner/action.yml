name: 'Dart/Flutter Security Scan'
description: 'Run scan for Dart/Flutter projects only'
inputs:
  repo-path:
    description: 'Path to the repository to scan'
    required: false
    default: '.'
  DART_SCANNER_TOKEN:
    description: 'Authentication token'
    required: true
  DART_SCANNER_REGION:
    description: 'Scanner Region token'
    required: true

runs:
  using: 'composite'
  steps:
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Detect Project Type
      id: detect
      shell: bash
      run: |
        REPO_PATH="${{ inputs.repo-path }}"

        if [ ! -f "${REPO_PATH}/pubspec.yaml" ]; then
          echo "::warning::No pubspec.yaml found - not a Dart/Flutter project"
          echo "is_dart=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        if grep -q "sdk: flutter" "${REPO_PATH}/pubspec.yaml" || grep -q "flutter:" "${REPO_PATH}/pubspec.yaml"; then
          echo "Project Type : Flutter"
          echo "is_flutter=true" >> $GITHUB_OUTPUT
          echo "is_dart=true" >> $GITHUB_OUTPUT
        else
          echo "Project Type : Dart"
          echo "is_flutter=false" >> $GITHUB_OUTPUT
          echo "is_dart=true" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ§° Set up Flutter SDK
      if: steps.detect.outputs.is_dart == 'true'
      uses: subosito/flutter-action@v2
      with:
        channel: stable

    - name: ğŸ“¦ Install required tools
      if: steps.detect.outputs.is_dart == 'true'
      working-directory: ${{ inputs.repo-path }}
      shell: bash
      run: |
        npm install -g snyk@latest @cyclonedx/cdxgen@latest >/dev/null 2>&1

    - name: ğŸ” Authenticating Tool
      if: steps.detect.outputs.is_dart == 'true'
      working-directory: ${{ inputs.repo-path }}
      shell: bash
      env:
        DART_SCANNER_TOKEN: ${{ inputs.DART_SCANNER_TOKEN }}
        DART_SCANNER_REGION: ${{ inputs.DART_SCANNER_REGION }}
      run: |
        echo "::add-mask::$DART_SCANNER_TOKEN"
        echo "::add-mask::$DART_SCANNER_REGION"

        snyk config set endpoint="https://api.${DART_SCANNER_REGION}.snyk.io" >/dev/null 2>&1

        snyk auth "$DART_SCANNER_TOKEN" >/dev/null 2>&1

    - name: ğŸ“¦ Resolve dependencies
      shell: bash
      if: steps.detect.outputs.is_dart == 'true'
      working-directory: ${{ inputs.repo-path }}
      run: |
        dart pub get >/dev/null 2>&1

    - name: ğŸ“Š Scan, Fail if Critical or High vulnerabilities found !!!
      if: steps.detect.outputs.is_dart == 'true'
      working-directory: ${{ inputs.repo-path }}
      shell: bash
      run: |
        cdxgen -t pub -o pub-sbom.json >/dev/null 2>&1

        if ! snyk sbom test --experimental --file pub-sbom.json --org=my-org-slug --json > sbom-result.json 2>&1; then
          echo "âš ï¸ Snyk test exited with a non-zero status, continuing to parse results..."
        fi

        if jq -e 'has("error")' sbom-result.json; then
          echo "::error::Scan failed: $(jq -r '.error' sbom-result.json)"
          exit 1
        fi

        critical=$(jq '[.vulnerabilities? // [] | .[] | select(.severity? == "critical")] | length' sbom-result.json)
        high=$(jq '[.vulnerabilities? // [] | .[] | select(.severity? == "high")] | length' sbom-result.json)
        unknown=$(jq '[.vulnerabilities? // [] | .[] | select(.severity? == "unknown")] | length' sbom-result.json)

        echo "::group::ğŸ“Š Vulnerability Summary"

        jq -er '
          if ((.vulnerabilities? // []) | length) == 0 then
            empty
          else
            .vulnerabilities
            | group_by(.severity?)[]
            | {
                severity: .[0].severity,
                issues: [.[] | {
                  id: .id?,
                  title: .title?,
                  pkg: .packageName?,
                  version: .version?
                }]
              }
            | (
                if .severity == "critical" then "\nğŸŸ£ CRITICAL SEVERITY"
                elif .severity == "high" then "\nğŸ”´ HIGH SEVERITY"
                elif .severity == "medium" then "\nğŸŸ  MEDIUM SEVERITY"
                elif .severity == "low" then "\nğŸŸ¡ LOW SEVERITY"
                else "\nâšª UNKNOWN SEVERITY"
                end
              ) + "\n" +
              (
                .issues[]
                | "\n- \(.title) [\(.id)]\n  ğŸ“¦ Package: \(.pkg)@\(.version)"
              )
          end
        ' sbom-result.json || echo "âœ… No vulnerabilities detected, Great job! ğŸ‰"


        echo "::endgroup::"

        if [[ "$critical" -gt 0 || "$high" -gt 0 ]]; then
          echo "::error::âŒ Scan failed due to high-severity issues:"
          echo "  ğŸŸ£ Critical vulnerabilities: $critical"
          echo "  ğŸ”´ High vulnerabilities: $high"
          exit 1
        elif [[ "$unknown" -gt 0 ]]; then
          echo "::warning::âšª Scan completed with $unknown unknown severity vulnerabilities"
        else
          echo "âœ… No Critical (ğŸŸ£) or High (ğŸ”´) vulnerabilities found. Great job! ğŸ‰"
        fi


    - name: ğŸ§¹ Cleanup
      shell: bash
      if: always() && steps.detect.outputs.is_dart == 'true'
      working-directory: ${{ inputs.repo-path }}
      run: |
        rm -f pub-sbom.json sbom-result.json

    - name: â„¹ï¸ Skip if not a Dart/Flutter project
      shell: bash
      if: steps.detect.outputs.is_dart != 'true'
      run: echo "ğŸŸ¡ Skipping scan - not a Dart/Flutter project"