name: Rust Security Scan

on:
  workflow_call:
    inputs:
      repo-path:
        description: 'Path to the repository to scan'
        required: false
        default: '.'
        type: string

    secrets:
      SNYK_SCANNER_TOKEN:
        required: true
      SNYK_SCANNER_REGION:
        required: true

jobs:
  rust-scan:
    name: Rust Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: 🧾 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Detect Project Type
        id: detect
        shell: bash
        run: |
          REPO_PATH="${{ inputs.repo-path }}"

          if [ ! -f "${REPO_PATH}/Cargo.toml" ]; then
            echo "::warning::No Cargo.toml found - not a Rust project"
            echo "is_rust=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Project Type : Rust"
          echo "is_rust=true" >> $GITHUB_OUTPUT

      - name: 📦 Install system libraries
        if: steps.detect.outputs.is_rust == 'true'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pkg-config libdbus-1-dev

      - name: 🦀 Set up Rust Toolchain with components
        if: steps.detect.outputs.is_rust == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: 📦 Install Rust analysis tools
        if: steps.detect.outputs.is_rust == 'true'
        shell: bash
        run: |
          cargo install cargo-cyclonedx || true
          cargo install cargo-audit || true
          npm install -g snyk@latest

      - name: 🔐 Authentication
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        shell: bash
        env:
          SNYK_SCANNER_TOKEN: ${{ secrets.SNYK_SCANNER_TOKEN }}
          SNYK_SCANNER_REGION: ${{ secrets.SNYK_SCANNER_REGION }}
        run: |
          echo "::add-mask::$SNYK_SCANNER_TOKEN"
          echo "::add-mask::$SNYK_SCANNER_REGION"

          snyk config set endpoint="https://api.${SNYK_SCANNER_REGION}.snyk.io" >/dev/null 2>&1
          snyk auth "$SNYK_SCANNER_TOKEN" >/dev/null 2>&1

      - name: 📦 Generate dependency metadata
        shell: bash
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        run: |
          echo "Generating Cargo dependency metadata..."
          cargo metadata --format-version=1 --no-deps > cargo-metadata.json

      - name: 🛡️ Run Cargo Audit (RustSec)
        shell: bash
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        run: |
          echo "Running cargo audit..."
          cargo audit --json > audit-result.json || true

      - name: 🔎 Snyk Code Test (SAST)
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        shell: bash
        run: |
          echo "Running Snyk Code Test with SARIF output..."
          snyk code test --sarif-file-output=snyk-code.sarif || true

          code_critical=$(jq '[.runs[0].results[]? | select(.level == "error")] | length' snyk-code.sarif)
          code_high=$(jq '[.runs[0].results[]? | select(.level == "warning")] | length' snyk-code.sarif)

          echo "code_critical=$code_critical" >> $GITHUB_ENV
          echo "code_high=$code_high" >> $GITHUB_ENV

      - name: 📊 Unified Vulnerability Scan
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        shell: bash
        run: |
          cargo cyclonedx --format json > cargo-sbom.json

          snyk sbom test --experimental --file cargo-sbom.json --org=affinidi --json > sbom-result.json || true

          # Merge Cargo Audit & Snyk SBOM results into a combined JSON
          jq -s '{cargo_audit: .[0], snyk: .[1]}' audit-result.json sbom-result.json > combined-result.json

          audit_critical=$(jq '[.cargo_audit.vulnerabilities.list[]? | select(.advisory.severity == "critical")] | length' combined-result.json)
          audit_high=$(jq '[.cargo_audit.vulnerabilities.list[]? | select(.advisory.severity == "high")] | length' combined-result.json)
          snyk_critical=$(jq '[.snyk.vulnerabilities? // [] | .[] | select(.severity == "critical")] | length' combined-result.json)
          snyk_high=$(jq '[.snyk.vulnerabilities? // [] | .[] | select(.severity == "high")] | length' combined-result.json)

          total_critical=$((audit_critical + snyk_critical + code_critical))
          total_high=$((audit_high + snyk_high + code_high))

          echo "::group::📊 Vulnerability Summary"

          # Cargo Audit vulnerabilities
          if [[ $(jq '.cargo_audit.vulnerabilities.list | length' combined-result.json) -gt 0 ]]; then
            echo "🦀 Cargo Audit Findings:"
            jq -r '
              .cargo_audit.vulnerabilities.list[] |
              "⚠️ [\(.advisory.severity // "unknown")] \(.advisory.title) - \(.package.name)@\(.package.version)"
            ' combined-result.json
          else
            echo "✅ No vulnerabilities detected by Cargo Audit!"
          fi

          echo

          # Snyk SBOM vulnerabilities
          if [[ $(jq '(.snyk.vulnerabilities? // []) | length' combined-result.json) -gt 0 ]]; then
            echo "🔍 Snyk SBOM Findings:"
            jq -r '
              .snyk.vulnerabilities[] |
              "⚠️ [\(.severity)] \(.title) - \(.packageName)@\(.version)"
            ' combined-result.json
          else
            echo "✅ No vulnerabilities detected by Snyk!"
          fi

          echo

          # Snyk Code Test vulnerabilities
          if [[ $code_critical -gt 0 || $code_high -gt 0 ]]; then
            echo "🔎 Snyk Code Test Findings:"
            jq -r '.runs[0].results[] | "⚠️ [\(.level)] \(.message.text)"' snyk-code.sarif
          else
            echo "✅ No code issues detected by Snyk Code Test!"
          fi

          echo "::endgroup::"

          if [[ "$total_critical" -gt 0 || "$total_high" -gt 0 ]]; then
            echo "::error::❌ Scan failed due to high-severity issues:"
            echo "  🟣 Critical vulnerabilities: $total_critical"
            echo "  🔴 High vulnerabilities: $total_high"
            exit 1
          else
            echo "✅ No Critical (🟣) or High (🔴) vulnerabilities found. Great job! 🎉"
          fi

      - name: 🗂 Convert Snyk SBOM JSON to SARIF
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        shell: bash
        run: |
          jq '{
            version: "2.1.0",
            runs: [
              {
                tool: { driver: { name: "Snyk SBOM Test" }},
                results: (.vulnerabilities? // []) | map({
                  ruleId: .id,
                  level: (if .severity == "critical" then "error"
                          elif .severity == "high" then "error"
                          elif .severity == "medium" then "warning"
                          else "note" end),
                  message: { text: .title },
                  locations: [{ physicalLocation: { artifactLocation: { uri: .packageName }}}]
                })
              }
            ]
          }' sbom-result.json > snyk-sbom.sarif

      - name: 🗂 Convert Cargo Audit JSON to SARIF
        if: steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        shell: bash
        run: |
          jq '{
            version: "2.1.0",
            runs: [
              {
                tool: { driver: { name: "Cargo Audit" }},
                results: (.vulnerabilities.list? // []) | map({
                  ruleId: .advisory.id,
                  level: (if .advisory.severity == "critical" then "error"
                          elif .advisory.severity == "high" then "error"
                          elif .advisory.severity == "medium" then "warning"
                          else "note" end),
                  message: { text: .advisory.title },
                  locations: [{ physicalLocation: { artifactLocation: { uri: .package.name }}}]
                })
              }
            ]
          }' audit-result.json > cargo-audit.sarif

      - name: 📤 Upload SARIF Results
        if: steps.detect.outputs.is_rust == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: |
            ${{ inputs.repo-path }}/snyk-code.sarif
            ${{ inputs.repo-path }}/snyk-sbom.sarif
            ${{ inputs.repo-path }}/cargo-audit.sarif

      - name: 🧹 Cleanup
        shell: bash
        if: always() && steps.detect.outputs.is_rust == 'true'
        working-directory: ${{ inputs.repo-path }}
        run: rm -f cargo-metadata.json cargo-sbom.json sbom-result.json audit-result.json combined-result.json snyk-code.sarif snyk-sbom.sarif cargo-audit.sarif

      - name: ℹ️ Skip if not a Rust project
        shell: bash
        if: steps.detect.outputs.is_rust != 'true'
        run: echo "🟡 Skipping scan - not a Rust project"
